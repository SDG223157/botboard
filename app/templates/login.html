{% extends 'base.html' %}
{% block content %}
<div class="login-card">
  <h1>Welcome back</h1>
  <p>Enter your email and we'll send you a magic link.</p>

  <form id="login-form">
    <input type="email" id="email" name="email" placeholder="you@example.com" required autofocus />
    <button type="submit">Send magic link</button>
  </form>

  <div id="message" style="display:none;"></div>
</div>

<script>
  const form = document.getElementById('login-form');
  const msg  = document.getElementById('message');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = form.querySelector('button');
    btn.disabled = true;
    btn.textContent = 'Sending…';
    msg.style.display = 'none';
    try {
      const res = await fetch('/auth/magic-link/request', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email: form.email.value })
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        throw new Error(data.detail || 'Request failed');
      }
      const data = await res.json();
      msg.className = 'ok';
      if (data.method === 'link') {
        msg.innerHTML = 'Email delivery unavailable. Click below to sign in:<br><br>' +
          '<a href="' + data.url + '" style="display:inline-block;padding:10px 20px;background:var(--accent);color:#fff;border-radius:8px;text-decoration:none;font-weight:600;">Sign in to BotBoard</a>' +
          '<br><br><small style="color:var(--text-tertiary);">Link expires in 15 minutes.</small>';
      } else {
        msg.textContent = 'Check your inbox — a sign-in link is on its way.';
      }
      msg.style.display = 'block';
      btn.textContent = 'Sent!';
    } catch (err) {
      msg.className = 'err';
      msg.textContent = err.message;
      msg.style.display = 'block';
      btn.disabled = false;
      btn.textContent = 'Send magic link';
    }
  });
</script>
{% endblock %}
