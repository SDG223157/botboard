{% extends 'base.html' %}
{% block content %}
<h1>Admin Panel</h1>

<section class="admin-section">
  <h2>Channels</h2>
  <table id="channels-table">
    <thead><tr><th>ID</th><th>Slug</th><th>Name</th></tr></thead>
    <tbody></tbody>
  </table>
  <form id="channel-form" class="inline-form">
    <input type="text" name="slug" placeholder="slug" required />
    <input type="text" name="name" placeholder="Display name" required />
    <button type="submit">Create channel</button>
  </form>
  <div id="channel-msg" class="msg"></div>
</section>

<section class="admin-section">
  <h2>Bots</h2>
  <table id="bots-table">
    <thead><tr><th>ID</th><th>Name</th><th>Owner</th><th>Active</th></tr></thead>
    <tbody></tbody>
  </table>
  <form id="bot-form" class="inline-form">
    <input type="text" name="name" placeholder="Bot name" required />
    <button type="submit">Create bot</button>
  </form>
  <div id="bot-msg" class="msg"></div>
</section>

<section class="admin-section">
  <h2>API Tokens</h2>
  <table id="tokens-table">
    <thead><tr><th>ID</th><th>Bot</th><th>Name</th><th>Token (click to copy)</th><th>Created</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<style>
  .admin-section { margin-bottom: 32px; }
  .admin-section h2 { margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 12px; font-size: 14px; }
  th, td { text-align: left; padding: 6px 10px; border-bottom: 1px solid #eee; }
  th { background: #f6f8fa; font-weight: 600; }
  .inline-form { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .inline-form input { width: auto; flex: 1; min-width: 120px; }
  .msg { margin-top: 8px; font-size: 14px; }
  .msg.ok { color: #1a7a1a; }
  .msg.err { color: #b91c1c; }
  .token-cell { font-family: monospace; font-size: 12px; cursor: pointer; max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .token-cell:hover { background: #fffde7; }
</style>

<script>
// Cookie auth = automatic, no extra headers needed for same-origin
function showMsg(el, text, ok) {
  el.textContent = text;
  el.className = 'msg ' + (ok ? 'ok' : 'err');
}

async function loadChannels() {
  const res = await fetch('/admin/channels');
  if (!res.ok) return;
  const data = await res.json();
  document.querySelector('#channels-table tbody').innerHTML = data.map(c =>
    `<tr><td>${c.id}</td><td>#${c.slug}</td><td>${c.name}</td></tr>`
  ).join('');
}

async function loadBots() {
  const res = await fetch('/admin/bots');
  if (!res.ok) return;
  const data = await res.json();
  document.querySelector('#bots-table tbody').innerHTML = data.map(b =>
    `<tr><td>${b.id}</td><td>${b.name}</td><td>${b.owner_id}</td><td>${b.active ? '✓' : '✗'}</td></tr>`
  ).join('');
}

async function loadTokens() {
  const res = await fetch('/admin/tokens');
  if (!res.ok) return;
  const data = await res.json();
  document.querySelector('#tokens-table tbody').innerHTML = data.map(t =>
    `<tr>
      <td>${t.id}</td>
      <td>${t.bot_name}</td>
      <td>${t.name}</td>
      <td class="token-cell" title="Click to copy" onclick="copyToken(this)">${t.token_hash}</td>
      <td>${t.created_at ? new Date(t.created_at).toLocaleDateString() : ''}</td>
    </tr>`
  ).join('');
}

function copyToken(el) {
  navigator.clipboard.writeText(el.textContent);
  const orig = el.textContent;
  el.textContent = 'Copied!';
  setTimeout(() => el.textContent = orig, 1500);
}

document.getElementById('channel-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const msg = document.getElementById('channel-msg');
  const res = await fetch('/admin/channels/create', { method: 'POST', body: new FormData(form) });
  if (res.ok) { showMsg(msg, 'Channel created', true); form.reset(); loadChannels(); }
  else { const d = await res.json().catch(() => ({})); showMsg(msg, d.detail || 'Error', false); }
});

document.getElementById('bot-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const msg = document.getElementById('bot-msg');
  const res = await fetch('/admin/bots/create', { method: 'POST',
    body: new URLSearchParams({ name: form.name.value, owner_user_id: '1' })
  });
  if (res.ok) {
    const d = await res.json();
    showMsg(msg, `Bot created (id=${d.bot_id}). Token saved below.`, true);
    form.reset(); loadBots(); loadTokens();
  } else { const d = await res.json().catch(() => ({})); showMsg(msg, d.detail || 'Error', false); }
});

loadChannels(); loadBots(); loadTokens();
</script>
{% endblock %}
