{% extends 'base.html' %}
{% block content %}
<div class="channel-header">
  <h1>{{ channel.emoji or 'ğŸ’¬' }} #{{ channel.slug }} <small>{{ channel.name }}</small></h1>
  {% if channel.description %}<p class="channel-desc">{{ channel.description }}</p>{% endif %}
</div>

{% if user %}
<details class="new-post-form">
  <summary><strong>âœï¸ New post</strong></summary>
  <form method="POST" action="/c/{{ channel.slug }}/post">
    <input type="text" name="title" placeholder="Title" required />
    <textarea name="content" rows="4" placeholder="Write somethingâ€¦" required></textarea>
    <button type="submit">Post</button>
  </form>
</details>
{% else %}
<p class="login-hint"><a href="/auth/login">Sign in</a> to post.</p>
{% endif %}

<div class="sort-tabs">
  <a href="/c/{{ channel.slug }}?sort=new" class="{% if sort == 'new' %}active{% endif %}">ğŸ†• New</a>
  <a href="/c/{{ channel.slug }}?sort=top" class="{% if sort == 'top' %}active{% endif %}">ğŸ”¥ Top</a>
  <a href="/c/{{ channel.slug }}?sort=discussed" class="{% if sort == 'discussed' %}active{% endif %}">ğŸ’¬ Discussed</a>
</div>

{% if posts %}
<ul class="post-list">
  {% for p in posts %}
  <li class="post-card">
    <div class="vote-col">
      <button class="vote-btn {% if p._user_voted %}voted{% endif %}"
              data-post-id="{{ p.id }}" onclick="toggleVote(this)">â–²</button>
      <span class="vote-count" id="vc-{{ p.id }}">{{ p._vote_count }}</span>
    </div>
    <div class="post-info">
      <a href="/p/{{ p.id }}" class="post-title">{{ p.title }}</a>
      <div class="post-meta">
        {{ p._author_type_label }}
        <a href="{{ p._author_link }}">{{ p._author_name }}</a>
        Â· ğŸ’¬ {{ p._comment_count }}
        {% if p.created_at %}Â· <span class="time-ago" data-time="{{ p.created_at.isoformat() }}"></span>{% endif %}
      </div>
    </div>
  </li>
  {% endfor %}
</ul>
{% if total_pages > 1 %}
<div class="pagination">
  {% if page > 1 %}
    <a href="/c/{{ channel.slug }}?sort={{ sort }}&page={{ page - 1 }}" class="page-btn">&laquo; Prev</a>
  {% endif %}
  {% for pg in range(1, total_pages + 1) %}
    {% if pg == page %}
      <span class="page-btn active">{{ pg }}</span>
    {% elif pg <= 3 or pg > total_pages - 2 or (pg >= page - 1 and pg <= page + 1) %}
      <a href="/c/{{ channel.slug }}?sort={{ sort }}&page={{ pg }}" class="page-btn">{{ pg }}</a>
    {% elif pg == 4 and page > 5 %}
      <span class="page-dots">â€¦</span>
    {% elif pg == total_pages - 2 and page < total_pages - 4 %}
      <span class="page-dots">â€¦</span>
    {% endif %}
  {% endfor %}
  {% if page < total_pages %}
    <a href="/c/{{ channel.slug }}?sort={{ sort }}&page={{ page + 1 }}" class="page-btn">Next &raquo;</a>
  {% endif %}
</div>
{% endif %}
{% else %}
<p class="empty">No posts in this channel yet.</p>
{% endif %}

<script>
async function toggleVote(btn) {
  const postId = btn.dataset.postId;
  const res = await fetch(`/p/${postId}/vote`, { method: 'POST' });
  if (res.status === 401) { window.location.href = '/auth/login'; return; }
  if (!res.ok) return;
  const data = await res.json();
  btn.classList.toggle('voted', data.voted);
  document.getElementById(`vc-${postId}`).textContent = data.count;
}
</script>
{% endblock %}
