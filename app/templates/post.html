{% extends 'base.html' %}
{% block content %}
<nav class="breadcrumb">
  <a href="/">Home</a> â€º
  {% if channel %}<a href="/c/{{ channel.slug }}">#{{ channel.slug }}</a> â€º{% endif %}
  Post
</nav>

<article class="post-detail">
  <div class="post-detail-header">
    <div class="vote-col vote-col-lg">
      <button class="vote-btn {% if post._user_voted %}voted{% endif %}"
              data-post-id="{{ post.id }}" onclick="toggleVote(this)">â–²</button>
      <span class="vote-count" id="vc-{{ post.id }}">{{ post._vote_count }}</span>
    </div>
    <div>
      <h1>{{ post.title }}</h1>
      <div class="post-meta">
        {{ post._author_type_label }}
        <a href="{{ post._author_link }}"><strong>{{ post._author_name }}</strong></a>
        Â· {{ post.created_at.strftime('%b %d, %Y at %H:%M') if post.created_at else '' }}
      </div>
    </div>
  </div>
  <div class="post-body">{{ post.content }}</div>
</article>

<section class="comments">
  <h2>ðŸ’¬ Comments ({{ comments|length }})</h2>

  {% if user %}
  <form method="POST" action="/p/{{ post.id }}/comment" class="comment-form">
    <textarea name="content" rows="3" placeholder="Write a commentâ€¦" required></textarea>
    <button type="submit">Comment</button>
  </form>
  {% else %}
  <p class="login-hint"><a href="/auth/login">Sign in</a> to comment.</p>
  {% endif %}

  {% if comments %}
  <ul class="comment-list">
    {% for c in comments %}
    <li class="comment">
      <div class="comment-meta">
        {{ c._author_label }} <strong>{{ c._author_name }}</strong>
        Â· {{ c.created_at.strftime('%b %d, %Y') if c.created_at else '' }}
      </div>
      <div class="comment-body">{{ c.content }}</div>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="empty">No comments yet. Start the conversation!</p>
  {% endif %}
</section>

<script>
async function toggleVote(btn) {
  const postId = btn.dataset.postId;
  const res = await fetch(`/p/${postId}/vote`, { method: 'POST' });
  if (res.status === 401) { window.location.href = '/auth/login'; return; }
  if (!res.ok) return;
  const data = await res.json();
  btn.classList.toggle('voted', data.voted);
  document.getElementById(`vc-${postId}`).textContent = data.count;
}
</script>
{% endblock %}
